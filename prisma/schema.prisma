generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  idUser          String      @id @default(uuid())
  nameUser        String?
  email           String      @unique
  password        String
  phoneNumber     String?
  address         String?
  role            Role        @default(USER)
  avatar          String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  accountType     accountType @default(LOCAL)
  isActive        Boolean     @default(false)
  gender          Gender      @default(Male)
  level           Level       @default(Low)
  xp              Int         @default(0)
  xpToNext        Int         @default(100) // ngưỡng để lên level tiếp theo
  currentStreak   Int         @default(0) // Chuỗi hiện tại
  longestStreak   Int         @default(0) // Chuỗi dài nhất từng đạt được
  lastStudiedAt   DateTime? // Ngày cuối cùng có hoạt động học
  targetExamDate  DateTime? // Ngày dự định thi IELTS
  targetBandScore Float? // Điểm mục tiêu (VD: 6.5, 7.0)

  test                   Test[]
  forumComment           ForumComment[]
  forumCommentLikes      ForumCommentLikes[]
  forumPosts             ForumPost[]
  forumPostLikes         ForumPostLikes[]
  forumThreads           ForumThreads[]
  Topic                  Topic[]
  Vocabulary             Vocabulary[]
  userAnswers            UserAnswer[]
  userTestResults        UserTestResult[]
  userWritingSubmissions UserWritingSubmission[]
  verificationCodes      VerificationCode[]
  grammarCategories      GrammarCategory[]
  speaking               UserSpeakingSubmission[]
}

model VerificationCode {
  idCode     String   @id @default(uuid())
  idUser     String
  token      String
  type       OTPType
  expiration DateTime
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
}

model UserTestResult {
  idTestResult    String       @id @default(uuid())
  idUser          String
  idTest          String
  score           Int?         @default(0) //score theo thang 40
  total_correct   Int?         @default(0)
  total_questions Int?         @default(0)
  raw_score       Int?         @default(0)
  band_score      Float        @default(0)
  duration        Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  finishedAt      DateTime?
  startedAt       DateTime     @default(now())
  status          TestStatus   @default(IN_PROGRESS)
  level           Level        @default(Low)
  userAnswer      UserAnswer[]
  test            Test         @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
  user            User         @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
}

model Vocabulary {
  idVocab       String    @id @default(uuid())
  word          String
  phonetic      String?
  meaning       String
  example       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  idUser        String
  idTopic       String?
  VocabType     VocabType
  level         Level?
  correctStreak Int       @default(0)
  lastReviewed  DateTime?
  xp            Int       @default(0)
  topic         Topic?    @relation(fields: [idTopic], references: [idTopic], onDelete: Cascade)
  user          User      @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
}

model Topic {
  idTopic    String       @id @default(uuid())
  nameTopic  String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  idUser     String
  user       User         @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  vocabulary Vocabulary[]
}

model Test {
  idTest           String             @id @default(uuid())
  idUser           String
  title            String
  duration         Int
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  testType         TestType
  img              String?
  description      String?
  numberQuestion   Int
  audioUrl         String?
  level            Level              @default(Low)
  user             User               @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  groupOfQuestions GroupOfQuestions[]
  parts            Part[]
  userTestResults  UserTestResult[]
  writingTasks     WritingTask[]
  speakingTasks    SpeakingTask[]
}

model Part {
  idPart           String             @id @default(uuid())
  idTest           String
  namePart         String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  question         Question[]
  passage          Passage?
  groupOfQuestions GroupOfQuestions[]
  test             Test               @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
}

model Passage {
  idPassage       String   @id @default(uuid())
  idPart          String   @unique
  title           String
  content         String
  image           String?
  description     String?
  numberParagraph Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  part            Part     @relation(fields: [idPart], references: [idPart], onDelete: Cascade)
}

model GroupOfQuestions {
  idGroupOfQuestions String       @id @default(uuid())
  idTest             String
  idPart             String
  title              String
  quantity           Int
  img                String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  typeQuestion       QuestionType
  question           Question[]
  test               Test         @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
  part               Part         @relation(fields: [idPart], references: [idPart], onDelete: Cascade)
}

model Question {
  idQuestion         String           @id @default(uuid())
  idGroupOfQuestions String
  idPart             String
  numberQuestion     Int
  content            String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  answers            Answer[]
  groupOfQuestions   GroupOfQuestions @relation(fields: [idGroupOfQuestions], references: [idGroupOfQuestions], onDelete: Cascade)
  part               Part             @relation(fields: [idPart], references: [idPart], onDelete: Cascade)
  userAnswers        UserAnswer[]
}

model Answer {
  idAnswer       String  @id @default(uuid())
  idQuestion     String
  answer_text    String? // Dành cho dạng câu hỏi không có lựa chọn như: FillBlank, ShortAnswer, Other
  matching_key   String? //A , B , C
  matching_value String? // Dành cho dạng câu hỏi Matching (Nối cặp).
  // Ví dụ: bạn có 2 cột cần nối: A: Country, B: Capital 
  //| matching_key | matching_value |
  //| ------------ | -------------- |
  //| "France"     | "Paris"        |
  //| "Japan"      | "Tokyo"        |

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  question  Question @relation(fields: [idQuestion], references: [idQuestion], onDelete: Cascade)
}

model UserAnswer {
  idUserAnswer   String         @id @default(uuid())
  idQuestion     String
  idUser         String
  answerText     String?
  submitted_at   DateTime       @default(now())
  isCorrect      Boolean        @default(false)
  idTestResult   String
  matching_key   String?
  matching_value String?
  userAnswerType QuestionType
  question       Question       @relation(fields: [idQuestion], references: [idQuestion], onDelete: Cascade)
  testResult     UserTestResult @relation(fields: [idTestResult], references: [idTestResult], onDelete: Cascade)
  user           User           @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  @@unique([idQuestion, idUser, idTestResult])
}

model WritingTask {
  idWritingTask          String                  @id @default(uuid())
  idTest                 String
  title                  String
  time_limit             Int
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  task_type              WritingTaskType
  image                  String?
  userWritingSubmissions UserWritingSubmission[]
  test                   Test                    @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
}

model UserWritingSubmission {
  idWritingSubmission String        @id @default(uuid())
  idUser              String
  idWritingTask       String
  submission_text     String
  submitted_at        DateTime      @default(now())
  status              WritingStatus @default(SUBMITTED)

  user        User        @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  writingTask WritingTask @relation(fields: [idWritingTask], references: [idWritingTask], onDelete: Cascade)

  feedback Feedback[]
}

model Feedback {
  idFeedback                  String @id @default(uuid())
  idWritingSubmission         String
  taskResponse                String @db.Text
  coherenceAndCohesion        String @db.Text
  lexicalResource             String @db.Text
  grammaticalRangeAndAccuracy String @db.Text
  generalFeedback             String @db.Text
  detailedCorrections         Json? //Lưu lỗi chi tiết

  gradedAt DateTime @default(now())

  submission UserWritingSubmission @relation(fields: [idWritingSubmission], references: [idWritingSubmission], onDelete: Cascade)
}

model ForumThreads {
  idForumThreads String      @id @default(uuid())
  idUser         String
  title          String
  content        String
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt
  forumPost      ForumPost[]
  user           User        @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
}

model ForumPost {
  idForumPost    String           @id @default(uuid())
  idForumThreads String
  idUser         String
  content        String
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  file           String?
  forumComment   ForumComment[]
  forumThreads   ForumThreads     @relation(fields: [idForumThreads], references: [idForumThreads], onDelete: Cascade)
  user           User             @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  forumPostLikes ForumPostLikes[]
}

model ForumComment {
  idForumComment    String              @id @default(uuid())
  idForumPost       String
  idUser            String
  content           String
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  forumPost         ForumPost           @relation(fields: [idForumPost], references: [idForumPost], onDelete: Cascade)
  user              User                @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  forumCommentLikes ForumCommentLikes[]
}

model ForumPostLikes {
  idForumPostLikes String    @id @default(uuid())
  idForumPost      String
  idUser           String
  created_at       DateTime  @default(now())
  forumPost        ForumPost @relation(fields: [idForumPost], references: [idForumPost], onDelete: Cascade)
  user             User      @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  @@unique([idForumPost, idUser])
}

model ForumCommentLikes {
  idForumCommentLikes String       @id @default(uuid())
  idForumComment      String
  idUser              String
  created_at          DateTime     @default(now())
  forumComment        ForumComment @relation(fields: [idForumComment], references: [idForumComment], onDelete: Cascade)
  user                User         @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  @@unique([idForumComment, idUser])
}

enum Level {
  Low
  Mid
  High
  Great
}

enum Gender {
  Male
  Female
}

enum OTPType {
  OTP
  RESET_LINK
}

enum accountType {
  LOCAL
  GOOGLE
}

enum Role {
  USER
  ADMIN
  GIAOVIEN
}

enum TestStatus {
  IN_PROGRESS
  FINISHED
  EXPIRED
  CANCELLED
}

enum VocabType {
  NOUN
  VERB
  ADJECTIVE
  ADVERB
  PHRASE
  IDIOM
  PREPOSITION
  CONJUNCTION
  INTERJECTION
}

enum TestType {
  LISTENING
  READING
  WRITING
  SPEAKING
}

enum QuestionType {
  MCQ
  TFNG
  YES_NO_NOTGIVEN
  MATCHING
  FILL_BLANK
  LABELING
  SHORT_ANSWER
  OTHER
}

enum WritingTaskType {
  TASK1
  TASK2
}

enum WritingStatus {
  SUBMITTED
  GRADED
}

model GrammarCategory {
  idGrammarCategory String   @id @default(uuid())
  name              String
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  idUser String? // null cho hệ thống, có giá trị cho user
  user   User?   @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  grammars GrammarsOnCategories[]

  @@unique([idUser, name])
}

model Grammar {
  idGrammar      String   @id @default(uuid())
  title          String
  explanation    String
  level          Level    @default(Low)
  commonMistakes Json?
  examples       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  order          Int      @default(0)

  categories GrammarsOnCategories[]
}

model GrammarsOnCategories {
  idGrammarCategory String
  idGrammar         String

  assignedAt DateTime @default(now())
  assignedBy String

  category GrammarCategory @relation(fields: [idGrammarCategory], references: [idGrammarCategory], onDelete: Cascade)
  grammar  Grammar         @relation(fields: [idGrammar], references: [idGrammar], onDelete: Cascade)

  @@id([idGrammarCategory, idGrammar])
}

model SpeakingTask {
  idSpeakingTask String   @id @default(uuid())
  idTest         String
  title          String // Ví dụ: "Speaking Test 1 - Topic: Travel"
  audioPromptUrl String? // Có thể là file audio của giám khảo
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  test            Test                     @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
  questions       SpeakingQuestion[] // Các câu hỏi cho Part 1, 2, 3
  userSubmissions UserSpeakingSubmission[] // Các bài nộp của user

  @@unique([idTest]) // Đảm bảo mỗi 'De' (loại SPEAKING) chỉ có 1 SpeakingTask
}

model SpeakingQuestion {
  idSpeakingQuestion String           @id @default(uuid())
  idSpeakingTask     String
  part               SpeakingPartType
  topic              String?
  prompt             String?          @db.Text // Câu hỏi chính, hoặc nội dung cue card
  subPrompts         Json? // Các gạch đầu dòng cho Part 2 (You should say...)
  preparationTime    Int              @default(0) // Thời gian chuẩn bị (giây), vd: 60 cho Part 2
  speakingTime       Int              @default(120) // Thời gian nói (giây)
  order              Int              @default(0) // Để sắp xếp thứ tự câu hỏi

  speakingTask SpeakingTask @relation(fields: [idSpeakingTask], references: [idSpeakingTask], onDelete: Cascade)
}

model UserSpeakingSubmission {
  idSpeakingSubmission String         @id @default(uuid())
  idUser               String
  idSpeakingTask       String
  audioUrl             String // URL tới file audio user đã ghi
  transcript           String?        @db.Text
  submittedAt          DateTime       @default(now())
  status               SpeakingStatus @default(SUBMITTED)

  user         User               @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  speakingTask SpeakingTask       @relation(fields: [idSpeakingTask], references: [idSpeakingTask], onDelete: Cascade)
  feedback     SpeakingFeedback[] // Phản hồi cho bài nộp này
}

model SpeakingFeedback {
  idSpeakingFeedback   String @id @default(uuid())
  idSpeakingSubmission String @unique // 1 bài nộp chỉ có 1 feedback tổng thể

  fluencyAndCoherence         String @db.Text
  lexicalResource             String @db.Text
  grammaticalRangeAndAccuracy String @db.Text
  pronunciation               String @db.Text

  generalFeedback     String   @db.Text
  detailedCorrections Json? // Lưu các lỗi chi tiết (phát âm, ngữ pháp)
  gradedAt            DateTime @default(now())

  submission UserSpeakingSubmission @relation(fields: [idSpeakingSubmission], references: [idSpeakingSubmission], onDelete: Cascade)
}

enum SpeakingPartType {
  PART1
  PART2
  PART3
}

enum SpeakingStatus {
  SUBMITTED
  GRADED
}
