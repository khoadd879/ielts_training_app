generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  idUser                 String                   @id @default(uuid())
  nameUser               String?
  email                  String                   @unique
  password               String
  phoneNumber            String?
  address                String?
  role                   Role                     @default(USER)
  avatar                 String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  accountType            accountType              @default(LOCAL)
  isActive               Boolean                  @default(false)
  gender                 Gender                   @default(Male)
  level                  Level                    @default(Low)
  xp                     Int                      @default(0)
  xpToNext               Int                      @default(100)
  currentStreak          Int                      @default(0)
  lastStudiedAt          DateTime?
  longestStreak          Int                      @default(0)
  targetBandScore        Float?
  targetExamDate         DateTime?
  forumComment           ForumComment[]
  forumCommentLikes      ForumCommentLikes[]
  forumPosts             ForumPost[]
  forumPostLikes         ForumPostLikes[]
  forumThreads           ForumThreads[]
  grammarCategories      GrammarCategory[]
  test                   Test[]
  Topic                  Topic[]
  userAnswers            UserAnswer[]
  speaking               UserSpeakingSubmission[]
  userTestResults        UserTestResult[]
  userWritingSubmissions UserWritingSubmission[]
  verificationCodes      VerificationCode[]
  Vocabulary             Vocabulary[]
}

model VerificationCode {
  idCode     String   @id @default(uuid())
  idUser     String
  token      String
  type       OTPType
  expiration DateTime
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
}

model UserTestResult {
  idTestResult       String                   @id @default(uuid())
  idUser             String
  idTest             String
  score              Int?                     @default(0) //score theo thang 40
  total_correct      Int?                     @default(0)
  total_questions    Int?                     @default(0)
  raw_score          Int?                     @default(0)
  band_score         Float                    @default(0)
  duration           Int                      @default(0)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  finishedAt         DateTime?
  startedAt          DateTime                 @default(now())
  status             TestStatus               @default(IN_PROGRESS)
  level              Level                    @default(Low)
  userAnswer         UserAnswer[]
  test               Test                     @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
  user               User                     @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  writingSubmission  UserWritingSubmission[]
  speakingSubmission UserSpeakingSubmission[]

  @@index([idUser, status, finishedAt])
  @@index([idTest, createdAt])
}

model Vocabulary {
  idVocab       String    @id @default(uuid())
  word          String
  phonetic      String?
  meaning       String
  example       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  idUser        String
  idTopic       String?
  VocabType     VocabType
  level         Level?
  correctStreak Int       @default(0)
  lastReviewed  DateTime?
  xp            Int       @default(0)
  topic         Topic?    @relation(fields: [idTopic], references: [idTopic], onDelete: Cascade)
  user          User      @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
}

model Topic {
  idTopic    String       @id @default(uuid())
  nameTopic  String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  idUser     String
  user       User         @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  vocabulary Vocabulary[]
}

model Test {
  idTest           String             @id @default(uuid())
  idUser           String
  title            String
  duration         Int
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  testType         TestType
  img              String?
  description      String?
  numberQuestion   Int
  audioUrl         String?
  level            Level              @default(Low)
  groupOfQuestions GroupOfQuestions[]
  parts            Part[]
  speakingTasks    SpeakingTask[]
  user             User               @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  userTestResults  UserTestResult[]
  writingTasks     WritingTask[]
}

model Part {
  idPart           String             @id @default(uuid())
  namePart         String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  idTest           String
  groupOfQuestions GroupOfQuestions[]
  test             Test               @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
  passage          Passage?
  question         Question[]
}

model Passage {
  idPassage       String   @id @default(uuid())
  idPart          String   @unique
  title           String
  content         String
  image           String?
  description     String?
  numberParagraph Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  part            Part     @relation(fields: [idPart], references: [idPart], onDelete: Cascade)
}

model GroupOfQuestions {
  idGroupOfQuestions String       @id @default(uuid())
  idTest             String
  idPart             String
  title              String
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  typeQuestion       QuestionType
  quantity           Int?         // Made optional - will be deprecated in favor of counting questions
  img                String?
  part               Part         @relation(fields: [idPart], references: [idPart], onDelete: Cascade)
  test               Test         @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
  question           Question[]

  @@index([idPart, typeQuestion])
}

model Question {
  idQuestion         String           @id @default(uuid())
  idGroupOfQuestions String
  idPart             String
  numberQuestion     Int
  content            String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  answers            Answer[]
  groupOfQuestions   GroupOfQuestions @relation(fields: [idGroupOfQuestions], references: [idGroupOfQuestions], onDelete: Cascade)
  part               Part             @relation(fields: [idPart], references: [idPart], onDelete: Cascade)
  userAnswers        UserAnswer[]

  @@index([idGroupOfQuestions, numberQuestion])
}

model Answer {
  idAnswer       String   @id @default(uuid())
  answer_text    String?
  matching_key   String?
  matching_value String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  idQuestion     String
  question       Question @relation(fields: [idQuestion], references: [idQuestion], onDelete: Cascade)
}

model UserAnswer {
  idUser         String
  answerText     String?
  submitted_at   DateTime       @default(now())
  isCorrect      Boolean        @default(false)
  idTestResult   String
  matching_key   String?
  matching_value String?
  userAnswerType QuestionType
  idQuestion     String
  idUserAnswer   String         @id @default(uuid())
  question       Question       @relation(fields: [idQuestion], references: [idQuestion], onDelete: Cascade)
  testResult     UserTestResult @relation(fields: [idTestResult], references: [idTestResult], onDelete: Cascade)
  user           User           @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  @@unique([idQuestion, idUser, idTestResult])
  @@index([idTestResult, isCorrect])
}

model WritingTask {
  idWritingTask          String                  @id @default(uuid())
  time_limit             Int
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  task_type              WritingTaskType
  image                  String?
  idTest                 String
  title                  String
  userWritingSubmissions UserWritingSubmission[]
  test                   Test                    @relation(fields: [idTest], references: [idTest], onDelete: Cascade)
}

model UserWritingSubmission {
  idWritingSubmission String        @id @default(uuid())
  idUser              String
  idWritingTask       String
  idTestResult        String?
  submission_text     String
  submitted_at        DateTime      @default(now())
  status              WritingStatus @default(SUBMITTED)

  user        User        @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  writingTask WritingTask @relation(fields: [idWritingTask], references: [idWritingTask], onDelete: Cascade)

  feedback        Feedback[]
  userTestResults UserTestResult? @relation(fields: [idTestResult], references: [idTestResult], onDelete: Cascade)

  @@index([idUser, status, submitted_at])
}

model Feedback {
  idFeedback                  String                @id @default(uuid())
  idWritingSubmission         String
  taskResponse                String
  coherenceAndCohesion        String
  lexicalResource             String
  grammaticalRangeAndAccuracy String
  generalFeedback             String
  gradedAt                    DateTime              @default(now())
  detailedCorrections         Json?
  submission                  UserWritingSubmission @relation(fields: [idWritingSubmission], references: [idWritingSubmission], onDelete: Cascade)
}

model ForumThreads {
  idForumThreads String      @id @default(uuid())
  idUser         String
  title          String
  content        String
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt
  forumPost      ForumPost[]
  user           User        @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
}

model ForumPost {
  idForumPost    String           @id @default(uuid())
  idForumThreads String
  idUser         String
  content        String
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  file           String?
  forumComment   ForumComment[]
  forumThreads   ForumThreads     @relation(fields: [idForumThreads], references: [idForumThreads], onDelete: Cascade)
  user           User             @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  forumPostLikes ForumPostLikes[]

  @@index([idForumThreads, created_at])
}

model ForumComment {
  idForumComment    String              @id @default(uuid())
  idForumPost       String
  idUser            String
  content           String
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  forumPost         ForumPost           @relation(fields: [idForumPost], references: [idForumPost], onDelete: Cascade)
  user              User                @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  forumCommentLikes ForumCommentLikes[]
}

model ForumPostLikes {
  idForumPostLikes String    @id @default(uuid())
  idForumPost      String
  idUser           String
  created_at       DateTime  @default(now())
  forumPost        ForumPost @relation(fields: [idForumPost], references: [idForumPost], onDelete: Cascade)
  user             User      @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  @@unique([idForumPost, idUser])
}

model ForumCommentLikes {
  idForumCommentLikes String       @id @default(uuid())
  idForumComment      String
  idUser              String
  created_at          DateTime     @default(now())
  forumComment        ForumComment @relation(fields: [idForumComment], references: [idForumComment], onDelete: Cascade)
  user                User         @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  @@unique([idForumComment, idUser])
}

model GrammarCategory {
  idGrammarCategory String                 @id @default(uuid())
  name              String
  description       String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  idUser            String?
  user              User?                  @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  grammars          GrammarsOnCategories[]

  @@unique([idUser, name])
}

model Grammar {
  idGrammar      String                 @id @default(uuid())
  title          String
  explanation    String
  level          Level                  @default(Low)
  commonMistakes Json?
  examples       Json?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  order          Int                    @default(0)
  categories     GrammarsOnCategories[]
}

model GrammarsOnCategories {
  idGrammarCategory String
  idGrammar         String
  assignedAt        DateTime        @default(now())
  assignedBy        String
  category          GrammarCategory @relation(fields: [idGrammarCategory], references: [idGrammarCategory], onDelete: Cascade)
  grammar           Grammar         @relation(fields: [idGrammar], references: [idGrammar], onDelete: Cascade)

  @@id([idGrammarCategory, idGrammar])
}

model SpeakingTask {
  idSpeakingTask String           @id @default(uuid())
  title          String
  part           SpeakingPartType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  idTest String
  test   Test   @relation(fields: [idTest], references: [idTest], onDelete: Cascade)

  questions SpeakingQuestion[]

  userSubmissions UserSpeakingSubmission[]

  @@unique([idTest, part])
}

model SpeakingQuestion {
  idSpeakingQuestion String @id @default(uuid())
  idSpeakingTask     String

  topic      String? // Ví dụ: "Hometown", "Work/Study"
  prompt     String? // Nội dung text câu hỏi
  subPrompts Json? // Các gợi ý (đặc biệt cho Part 2 Cue Card)

  preparationTime Int @default(0)
  speakingTime    Int @default(120)
  order           Int @default(0)

  speakingTask SpeakingTask @relation(fields: [idSpeakingTask], references: [idSpeakingTask], onDelete: Cascade)
}

model UserSpeakingSubmission {
  idSpeakingSubmission String  @id @default(uuid())
  idUser               String
  idSpeakingTask       String
  idTestResult         String?

  audioUrl    String
  submittedAt DateTime       @default(now())
  status      SpeakingStatus @default(SUBMITTED)

  transcript String?

  feedback SpeakingFeedback?

  speakingTask    SpeakingTask    @relation(fields: [idSpeakingTask], references: [idSpeakingTask], onDelete: Cascade)
  userTestResults UserTestResult? @relation(fields: [idTestResult], references: [idTestResult])
  user            User            @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
}

model SpeakingFeedback {
  idSpeakingFeedback   String @id @default(uuid())
  idSpeakingSubmission String @unique

  scoreFluency       Float?
  scoreLexical       Float?
  scoreGrammar       Float?
  scorePronunciation Float?
  overallScore       Float?

  commentFluency       String?
  commentLexical       String?
  commentGrammar       String?
  commentPronunciation String?
  generalFeedback      String
  detailedCorrections  Json?

  gradedAt   DateTime               @default(now())
  submission UserSpeakingSubmission @relation(fields: [idSpeakingSubmission], references: [idSpeakingSubmission], onDelete: Cascade)
}

enum Level {
  Low
  Mid
  High
  Great
}

enum Gender {
  Male
  Female
}

enum OTPType {
  OTP
  RESET_LINK
}

enum accountType {
  LOCAL
  GOOGLE
}

enum Role {
  USER
  ADMIN
  GIAOVIEN
}

enum TestStatus {
  IN_PROGRESS
  FINISHED
  EXPIRED
  CANCELLED
}

enum VocabType {
  NOUN
  VERB
  ADJECTIVE
  ADVERB
  PHRASE
  IDIOM
  PREPOSITION
  CONJUNCTION
  INTERJECTION
}

enum TestType {
  LISTENING
  READING
  WRITING
  SPEAKING
}

enum QuestionType {
  MCQ
  TFNG
  YES_NO_NOTGIVEN
  MATCHING
  FILL_BLANK
  LABELING
  SHORT_ANSWER
  OTHER
}

enum WritingTaskType {
  TASK1
  TASK2
}

enum WritingStatus {
  SUBMITTED
  GRADED
}

enum SpeakingPartType {
  PART1
  PART2
  PART3
}

enum SpeakingStatus {
  SUBMITTED
  GRADED
}
